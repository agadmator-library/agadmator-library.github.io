<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>agadmator-library</title>
    <meta name="description" content="List (library) of all agadmator videos.">
    <meta name="author" content="SitePoint">

    <meta property="og:title" content="agadmator-library">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://agadmator-library.github.io">
    <meta property="og:description" content="List (library) of all agadmator videos.">
    <meta property="og:image" content="image.png">

    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
</head>
<style>
    .page-number-selector {
        width: 3em
    }

    #openingInput {
        width: 100%;
    }

    .dropdown-menu, span.twitter-typeahead .tt-menu {
        position: absolute;
        top: 100%;
        left: 0;
        display: none;
        float: left;
        padding: 5px 0;
        margin: 2px 0 0;
        font-size: 1rem;
        background-color: #fff;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 0.25rem;
    }

    span.twitter-typeahead .tt-suggestion {
        display: block;
        padding: 3px 15px;
        clear: both;
        line-height: 1.5;
    }

    span.twitter-typeahead .tt-suggestion:focus, .dropdown-item:hover, span.twitter-typeahead .tt-suggestion:hover {
        color: #2b2d2f;
        text-decoration: none;
        background-color: #f5f5f5;
    }

    span.twitter-typeahead {
        width: 100%;
    }

</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MX1CWFQ3KN"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-MX1CWFQ3KN');
</script>

<body>

<div class="container">


    <div class="card mt-2">
        <div class="card-header">
            Filters
            <button class="btn btn-light float-end p-0" type="button" data-bs-toggle="collapse"
                    href="#filtersCard" aria-expanded="false" aria-controls="filtersCard">
                &#x21D5;
            </button>
        </div>

        <div class="card-body collapse show" id="filtersCard">
            <div class="card">
                <div class="card-header" data-bs-toggle="collapse"
                     href="#playerFiltersCard" aria-expanded="false" aria-controls="playerFiltersCard">
                    Player filters
                    <button class="btn btn-light float-end p-0" type="button">
                        &#x21D5;
                    </button>
                </div>
                <div class="card-body collapse show" id="playerFiltersCard">
                    <form class="row align-items-center " action="" id="playerFilterForm">
                        <div class="col-auto px-1">
                            <label class="visually-hidden" for="playerSideSelect">Select side</label>
                            <select class="form-control" id="playerSideSelect">
                                <option value="anySide">Any side</option>
                                <option value="white">White</option>
                                <option value="black">Black</option>
                            </select>
                        </div>
                        <div class="col-auto px-1">
                            <label class="visually-hidden" for="playerResultSelect">Player result</label>
                            <select class="form-control" id="playerResultSelect">
                                <option value="" selected>Any result</option>
                                <option value="won">Won</option>
                                <option value="lost">Lost</option>
                                <option value="draw">Draw</option>
                            </select>
                        </div>
                        <div class="col px-1">
                            <label class="visually-hidden" for="playerInput">Player</label>
                            <input id="playerInput"
                                   type="text"
                                   class="form-control flex-fill"
                                   placeholder="Player"
                                   autocomplete="off">
                        </div>
                    </form>

                </div>
            </div>
            <div class="card mt-2">
                <div class="card-header" data-bs-toggle="collapse"
                     href="#videoFiltersCard" aria-expanded="false" aria-controls="videoFiltersCard">
                    Video filters
                    <button class="btn btn-light float-end p-0" type="button">
                        &#x21D5;
                    </button>
                </div>
                <div class="card-body collapse" id="videoFiltersCard">
                    <form class="row align-items-center " action="" id="videoFiltersForm">
                        <div class="row">
                            <div class="col px-1">
                                <label class="visually-hidden" for="titleInput">Title contains</label>
                                <input type="text" class="form-control" id="titleInput"
                                       placeholder="Title contains"
                                       autocomplete="off">
                            </div>

                        </div>
                        <div class="row mt-1">
                            <div class="col">
                                <label for="publishedFrom">Published from</label>
                                <input id="publishedFrom" class="form-control" type="date"/>
                            </div>
                            <div class="col">
                                <label for="publishedTo">Published to</label>
                                <input id="publishedTo" class="form-control" type="date"/>
                            </div>
                        </div>

                        <div class="row mt-1">
                            <div class="col-auto px-1">
                                <div class="form-check">
                                    <label class="form-check-label" for="multipleGamesCheck">
                                        Multiple games in video
                                    </label>
                                    <input class="form-check-input" type="checkbox" id="multipleGamesCheck">
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
            <div class="card mt-2">
                <div class="card-header" data-bs-toggle="collapse"
                     href="#gameFiltersCard" aria-expanded="false" aria-controls="gameFiltersCard">
                    Game filters
                    <button class="btn btn-light float-end p-0" type="button">
                        &#x21D5;
                    </button>
                </div>
                <div class="card-body collapse" id="gameFiltersCard">
                    <form class="row align-items-center mb-2" action="" id="playerNamesFilterForm">
                        <div class="col-auto px-1">
                            <label class="visually-hidden" for="openingInput">Opening</label>
                            <input id="openingInput"
                                   type="text"
                                   class="form-control"
                                   placeholder="Opening"
                                   autocomplete="off">
                        </div>
                        <div class="col-auto px-1">
                            <label class="visually-hidden" for="resultSelect">Result</label>
                            <select class="form-control " id="resultSelect">
                                <option value="" selected disabled hidden>Result</option>
                                <option value="w">White won</option>
                                <option value="b">Black won</option>
                                <option value="d">Draw</option>
                                <option value="na">n/a</option>
                            </select>
                        </div>
                        <div class="col-auto px-1">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="b4Check">
                                <label class="form-check-label" for="b4Check">
                                    White played b4!!!
                                </label>
                            </div>
                        </div>
                    </form>
                    <div>
                        <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapsibleBoardFilter"
                           role="button"
                           id="collapsibleBoardFilterButton" aria-expanded="false"
                           aria-controls="collapsibleBoardFilter">
                            Filter by playing moves
                        </a>
                        <div class="collapse mt-1 ml-4" id="collapsibleBoardFilter" style="width: 100%">
                            <form class="form-inline" action="" id="transpositionForm">
                                <div class="form-check mb-2 mr-sm-2">
                                    <label class="form-check-label" for="transpositionCheck">
                                        Include transpositions
                                    </label>
                                    <input class="form-check-input ml-2" type="checkbox" id="transpositionCheck">
                                </div>
                            </form>
                            <div id="boardFilter">
                            </div>
                            <a class="btn btn-primary mt-1" role="button" id="backOneStep">
                                Back one step
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-header" data-bs-toggle="collapse"
             href="#filtersContainerBody" aria-expanded="false" aria-controls="filtersContainerBody">
            Filters applied
            <button class="btn btn-light float-end p-0" type="button">
                &#x21D5;
            </button>
        </div>

        <div class="card-body collapse show" id="filtersContainerBody">
            <div id="filtersContainer">
            </div>
            <button id="clearFilterButton" type="submit" class="btn btn-primary float-end">Clear filters
            </button>

        </div>
        <div id="filterResultsContainer" class="card-footer text-muted"
             data-toggle="tooltip"
             data-placement="top"
             title="'with players' are videos with players names present. 'with moves' are videos eligible for opening and PGN filter.">
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-body">
            <div class="btn-group btn-group-sm" role="group">
                <button id="watchTopOnYoutubeButton"
                        class="btn btn-primary m-2"
                        data-container="body"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Opens YouTube playlist with top filtered videos (up to 50).">
                    Watch top 50 on YouTube
                </button>
                <button id="watchOnYoutubeButton"
                        class="btn btn-primary m-2"
                        data-container="body"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Opens YouTube playlist with currently visible (page) videos.">
                    Watch visible on YouTube
                </button>
                <button id="showResultButton"
                        class="btn btn-primary m-2"
                        data-container="body">
                    Show result column
                </button>
                <button id="hideResultButton"
                        class="btn btn-primary m-2"
                        style="display: none"
                        data-container="body">
                    Hide result column
                </button>
            </div>
        </div>
    </div>


    <div class="table-responsive mt-1">
        <table class="table table-sm table-hover table-striped">
            <thead>
            <tr>
                <th id="dateColHeader" class="d-none d-lg-block" scope="col">
                    Published at<span class="ms-1">&#x21D5;</span></th>
                <th id="titleColHeader" scope="col">Title<span class="ms-1">&#x21D5;</span></th>
                <th id="whiteColHeader" scope="col">White<span class="ms-1">&#x21D5;</span></th>
                <th id="blackColHeader" scope="col">Black<span class="ms-1">&#x21D5;</span></th>
                <th id="yearColHeader" class="table-cell" scope="col">Year<span
                        class="ms-1">&#x21D5;</span>
                </th>
                <th id="resultColHeader" scope="col" style="display: none">Result</th>
            </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <nav>
        <ul class="pagination justify-content-center" id="tablePagination">
            <li id="firstPageLink" class="page-item">
                <span class="visually-hidden">First</span>
                <span class="page-link">&laquo;</span>
            </li>
            <li id="previousPageLink" class="page-item">
                <a class="page-link" href="#">
                    <span aria-hidden="true">‹</span>
                    <span class="visually-hidden">Previous</span>
                </a>
            </li>
            <li id="nextPageLink" class="page-item">
                <a class="page-link" href="#">
                    <span aria-hidden="true">›</span>
                    <span class="visually-hidden">Next</span>
                </a>
            </li>
            <li id="lastPageLink" class="page-item">
                <span class="visually-hidden">Last</span>
                <span class="page-link">&raquo;</span>
            </li>
        </ul>
    </nav>

</div>


<footer class="page-footer font-small indigo">

    <div class="footer-copyright text-center py-3">This is only a fun project and not everything is properly parsed.
        Do
        not trust entirely.
    </div>
    <div class="footer-copyright text-center py-3">Report missing/invalid data by creating an issue on <a
            href="https://github.com/agadmator-library/agadmator-library.github.io/issues"
            target="_blank">GitHub</a> or
        by writing <a href="https://twitter.com" target="_blank">Twitter</a> post with phrase 'agadmator-library'.
        Do
        not forget to add YouTube url
    </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
        integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
        crossorigin="anonymous"></script>
<script defer src="js/chessboard-1.0.0.min.js"></script>
<script defer src="js/typeahead.jquery.js"></script>
<script type="module">
    class Game {
        pgn = undefined
        b4Played = undefined

        constructor(white, black, result, year) {
            this.white = white
            this.black = black
            this.result = result
            this.year = year
        }

        getWhiteOrEmpty() {
            return _.defaultTo(this.white, "")
        }

        getBlackOrEmpty() {
            return _.defaultTo(this.black, "")
        }
    }

    class Video {
        constructor(id, date, title, games) {
            this.id = id
            this.title = title
            this.date = date
            this.games = games
        }
    }

    let currentPageNumber = 1 // 1-based
    let pageSize = 30
    let videos = []
    let filteredVideos = []
    let filters = {
        anySide: [],
        white: [],
        black: [],
        opening: [],
        results: [],
        pgnFilter: "",
        title: "",
        b4Played: null
    }
    let openings = []
    let positions = {}
    let sortBy = "date"
    let sortDirection = "desc"
    let showResult = false

    $("#playerNamesFilterForm").on('submit', function (event) {
        event.preventDefault();
    });
    $("#openingFilterForm").on('submit', function (event) {
        event.preventDefault();
    });
    $(".page-link").on('click', function (event) {
        event.preventDefault();
    });
    $("#firstPageLink").on('click', () => changePage(1))
    $("#previousPageLink").on('click', () => {
        if (currentPageNumber > 1) {
            changePage(currentPageNumber - 1)
        }
    })
    $('#nextPageLink').on('click', () => {
        if (currentPageNumber < filteredVideos.length / pageSize) {
            changePage(currentPageNumber + 1)
        }
    })
    $("#lastPageLink").on('click', () => {
        changePage(parseInt(filteredVideos.length / pageSize) + 1)
    })

    function testWhite(filter, video) {
        return video.games && _.some(video.games, game => {
            return game.getWhiteOrEmpty().toLowerCase() === filter.playerName.toLowerCase()
                && (filter.playerResult === "" || (game.result && (
                    game.result === "w" && filter.playerResult === "won"
                    || game.result === "b" && filter.playerResult === "lost"
                    || game.result === "d" && filter.playerResult === "draw"
                )))
        })
    }

    function testBlack(filter, video) {
        return video.games && _.some(video.games, game => {
            return game.getBlackOrEmpty().toLowerCase() === filter.playerName.toLowerCase()
                && (filter.playerResult === "" || (game.result && (
                    game.result === "w" && filter.playerResult === "lost"
                    || game.result === "b" && filter.playerResult === "won"
                    || game.result === "d" && filter.playerResult === "draw"
                )))
        })
    }

    document.getElementById('openingInput').addEventListener('input', function (event) {
        if (event.inputType === "insertReplacementText") {
            filters.opening.push(event.data)

            applyFilters(true)

            document.getElementById('openingInput').value = ""
        }
    })

    document.getElementById('titleInput').addEventListener('input', event => {
        filters.title = event.target.value
        applyFilters(true)
    })

    $("#clearFilterButton").on('click', clearFilters)

    $("#backOneStep").on('click', function () {
        game.undo()
        board.position(game.fen())
        filters.pgnFilter = game.pgn() ? game.pgn() : ""
        applyFilters(true)
    })

    $('#resultSelect').change(function () {
        if (filters.results.indexOf($(this).val()) < 0) {
            filters.results.push($(this).val())
        }
        applyFilters(true)
        setTimeout(function () {
            document.getElementById('resultSelect').value = ""
        }, 1)
    })

    $('#b4Check').change(function () {
        if ($(this).prop("checked")) {
            filters.b4Played = true
        } else {
            filters.b4Played = null
        }
        $(this).prop("checked", false)
        applyFilters(true)
    })

    $('#multipleGamesCheck').change(function () {
        if ($(this).prop("checked")) {
            filters.multipleGames = true
        } else {
            filters.multipleGames = null
        }
        $(this).prop("checked", false)
        applyFilters(true)
    })

    $('#transpositionCheck').change(function () {
        if (filters.pgnFilter) {
            applyFilters(false)
        }
    })
    $('#publishedFrom').change(function() {
        applyFilters(false)
    })
    $('#publishedTo').change(function() {
        applyFilters(false)
    })

    function onSortClick(field) {
        if (sortBy === field) {
            sortDirection = sortDirection === "asc" ? "desc" : "asc"
        } else {
            sortBy = field
            sortDirection = ["w", "b", "title"].includes(field) ? "asc" : "desc"
        }
        applyFilters(true)
    }

    document.getElementById('dateColHeader').addEventListener('click', () => onSortClick('date'))
    document.getElementById('titleColHeader').addEventListener('click', () => onSortClick('title'))
    document.getElementById('whiteColHeader').addEventListener('click', () => onSortClick('w'))
    document.getElementById('blackColHeader').addEventListener('click', () => onSortClick('b'))
    document.getElementById('yearColHeader').addEventListener('click', () => onSortClick('year'))

    function watchIdsOnYoutube(ids) {
        if (ids === "") {
            return
        }
        const url = `https://www.youtube.com/watch_videos?video_ids=${ids}`
        window.open(url, '_blank').focus();
    }

    $('#watchTopOnYoutubeButton').on('click', function () {
        const ids = filteredVideos.slice(0, 50)
            .map(video => video.id)
            .join(",");
        watchIdsOnYoutube(ids);
    })

    $('#watchOnYoutubeButton').on('click', function () {
        const ids = filteredVideos.slice((currentPageNumber - 1) * pageSize, (currentPageNumber) * pageSize)
            .map(video => video.id)
            .join(",");
        watchIdsOnYoutube(ids)
    })

    $('#showResultButton').on('click', function () {
        showResult = true
        $('#resultColHeader').css("display", "table-cell");
        $('#showResultButton').css("display", "none")
        $('#hideResultButton').css("display", "block")
        draw()
    })

    $('#hideResultButton').on('click', function () {
        showResult = false
        $('#resultColHeader').css("display", "none");
        $('#showResultButton').css("display", "block")
        $('#hideResultButton').css("display", "none")
        draw()
    })

    let videosLoadedPromiseResolve;
    const videosLoadedPromise = new Promise((resolve, reject) => videosLoadedPromiseResolve = resolve)
    fetch("generated/db.json")
        .then(res => res.json())
        .then(res => {
            function decodeResult(result) {
                switch (result) {
                    case 1:
                        return "w"
                    case 0:
                        return "d"
                    case -1:
                        return "b"
                    default:
                        return null
                }
            }

            const toTyped = res.videos.map(dbVideo => {
                let games = dbVideo.g
                    ? dbVideo.g.map(g => new Game(res.players[g.w], res.players[g.b], decodeResult(g.r), g.y))
                    : []
                return new Video(dbVideo.id, new Date(dbVideo.d * 1000), dbVideo.t, games)
            })

            videos = filteredVideos = _.orderBy(toTyped, [sortBy], [sortDirection])

            let tmpPlayerNames = {}
            videos.filter(video => video.games)
                .flatMap(video => video.games)
                .filter(game => game.white && game.black)
                .forEach(game => {
                    tmpPlayerNames[game.white] = tmpPlayerNames[game.white] ? tmpPlayerNames[game.white] + 1 : 1
                    tmpPlayerNames[game.black] = tmpPlayerNames[game.black] ? tmpPlayerNames[game.black] + 1 : 1
                })
            let players = _.orderBy(Object.keys(tmpPlayerNames)
                .map(name => {
                    return {
                        name: name,
                        count: tmpPlayerNames[name]
                    }
                }), ["count", "name"], ["desc", "asc"])
                .map(player => player.name)

            $('#playerInput').typeahead({
                    minLength: 1,
                    highlight: true
                },
                {
                    name: 'players-dataset',
                    limit: 15,
                    source: function (query, syncResults) {
                        syncResults(players.filter(name => name.toLowerCase().includes(query.toLowerCase())))
                    }
                })
                .bind('typeahead:select', function (ev, suggestion) {
                    const side = document.getElementById('playerSideSelect').value
                    const filter = {
                        playerName: suggestion,
                        playerResult: document.getElementById('playerResultSelect').value
                    }
                    filters[side].push(filter)

                    applyFilters(true)

                    setTimeout(function () {
                        document.getElementById('playerSideSelect').value = "anySide"
                        document.getElementById('playerInput').value = ""
                        document.getElementById('playerResultSelect').value = ""
                    }, 1)
                })
                .bind('typeahead:change', function () {
                    setTimeout(function () {
                        document.getElementById('playerSideSelect').value = "anySide"
                        document.getElementById('playerInput').value = ""
                        document.getElementById('playerResultSelect').value = ""
                    }, 1)
                })

            const url = new URL(window.location);
            const s = url.searchParams.get('s')
            if (s) {
                let state = JSON.parse(decodeURIComponent(atob(s)))
                filters = state.filters
                sortBy = state.sortBy
                sortDirection = state.sortDirection
            }
            pushHistory();

            videosLoadedPromiseResolve()

            applyFilters(false)
        })

    fetch("generated/pgns.json")
        .then(res => res.json())
        .then(res => {
            videosLoadedPromise.then(_ => {

                videos.forEach(video => {
                    const videoPgns = res[video.id]
                    if (videoPgns) {
                        videoPgns.forEach((pgn, idx) => {
                            video.games[idx].pgn = pgn
                            video.games[idx].b4Played = /\d\.\s+b4/.test(pgn)
                        })
                    }
                })

                drawFilterResultsContainer()

                if (filters.pgnFilter || filters.opening.length > 0 || filters.b4Played) {
                    applyFilters(false)
                }
            })
        })

    fetch("generated/positions.json")
        .then(response => response.json())
        .then(responseJson => {
            positions = responseJson
            positions.videos.forEach((videoId, positionIndex) => videos.find(video => video.id === videoId).positionIndex = positionIndex)
        })

    fetch("generated/openings-slim.json")
        .then(response => response.json())
        .then(responseJson => {
            openings = responseJson

            $('#openingInput').typeahead({
                    minLength: 1,
                    highlight: true
                },
                {
                    name: 'openings-dataset',
                    limit: 15,
                    source: function (query, syncResults) {
                        syncResults(openings.map(opening => opening.name)
                            .filter(name => name.toLowerCase().includes(query.toLowerCase()))
                        )
                    }
                })
                .bind('typeahead:select', function (ev, suggestion) {
                    filters.opening.push(suggestion)

                    applyFilters(true)
                    setTimeout(function () {
                        document.getElementById('openingInput').value = ""
                    }, 1)
                })
                .bind('typeahead:change', function (ev, suggestion) {
                    setTimeout(function () {
                        document.getElementById('openingInput').value = ""
                    }, 1)
                })
        })

    function changePage(number, forbidScroll) {
        currentPageNumber = number
        draw()

        if (!forbidScroll) {
            setTimeout(function () {
                document.getElementById("lastPageLink").scrollIntoView()
            }, 10)
        }
    }

    function clearFilters() {
        filters = {
            anySide: [],
            white: [],
            black: [],
            opening: [],
            results: [],
            pgnFilter: "",
            title: "",
            b4Played: null
        }
        if (board) {
            board.position("start")
            game.reset()
        }
        document.getElementById('titleInput').value = ""
        document.getElementById('publishedFrom').value = ""
        document.getElementById('publishedTo').value = ""
        applyFilters(true)
    }

    onpopstate = (event) => {
        const state = JSON.parse(decodeURIComponent(atob(event.state)))
        filters = state.filters ? state.filters : filters
        sortBy = state.sortBy ? state.sortBy : sortBy
        sortDirection = state.sortDirection ? state.sortDirection : sortDirection
        applyFilters(false)
    };

    function pushHistory() {
        let state = {
            filters: filters,
            sortBy: sortBy,
            sortDirection: sortDirection
        }
        let encodedState = btoa(encodeURIComponent(JSON.stringify(state, null, "")));

        const url = new URL(window.location);
        url.searchParams.set('s', encodedState)

        history.pushState(encodedState, 'agadmator-library', url);
    }

    function applyFilters(shouldPushHistory) {
        if (shouldPushHistory) {
            pushHistory();
        }

        const pgnPrefixes = openings
            .filter(opening => _.some(filters.opening, filterOpening => opening.name === filterOpening))
            .map(opening => opening.moves)
        const includeTranspositions = document.getElementById('transpositionCheck').checked
        const publishedFrom = document.getElementById('publishedFrom').value
        const publishedTo = document.getElementById('publishedTo').value

        filteredVideos = videos
            .filter(video => {
                if (filters.anySide.length === 0) {
                    return true
                } else {
                    return _.some(filters.anySide, filter => testWhite(filter, video) || testBlack(filter, video))
                }
            })
            .filter(video => filters.white.length === 0 || _.some(filters.white, filter => testWhite(filter, video)))
            .filter(video => filters.black.length === 0 || _.some(filters.black, filter => testBlack(filter, video)))
            .filter(video => !filters.multipleGames || video.games.length > 1)
            .filter(video => {
                if (pgnPrefixes.length === 0) {
                    return true
                }

                return _.some(pgnPrefixes, pgnPrefix => _.some(video.games, game => game.pgn && game.pgn.indexOf(pgnPrefix) === 0))
            })
            .filter(video => {
                if (filters.pgnFilter === "") {
                    return true
                }

                return _.some(video.games, game => game.pgn && game.pgn.indexOf(filters.pgnFilter) === 0)
                    || includeTranspositions && positions && positions[game.fen().replaceAll(/ - \d+ \d+/g, "")] && positions[game.fen().replaceAll(/ - \d+ \d+/g, "")].includes(video.positionIndex)
            })
            .filter(video => !filters.title || video.title.toLowerCase().includes(filters.title.toLowerCase()))
            .filter(video => {
                if (filters.results.length === 0) {
                    return true
                } else {
                    const videoResult = video.games[0] ? video.games[0].result : null
                    return filters.results.indexOf(videoResult) >= 0 || !videoResult && filters.results.indexOf("na") >= 0
                }
            })
            .filter(video => !filters.b4Played || _.some(video.games, game => game.b4Played))
            .filter(video => {
                return !publishedFrom || video.date > new Date(publishedFrom)
            })
            .filter(video => {
                return !publishedTo || video.date < new Date(publishedTo).setHours(23, 59, 59)
            })

        filteredVideos = _.sortBy(filteredVideos, function (video) {
            if (sortBy === "date") {
                return video.date
            } else if (sortBy === "title") {
                return video.title.replaceAll(/[^\p{L}\d -]/gu, "").toLowerCase()
            } else if (sortBy === "w") {
                return (video.games[0] ? video.games[0].getWhiteOrEmpty() : "").toLowerCase()
            } else if (sortBy === "b") {
                return (video.games[0] ? video.games[0].getBlackOrEmpty() : "").toLowerCase()
            } else if (sortBy === "year") {
                return video.games[0] && video.games[0].year ? video.games[0].year : ""
            } else {
                return ""
            }
        })
        if (sortDirection === "desc") {
            filteredVideos.reverse()
        }

        let watchOnYoutubeButton = document.getElementById('watchOnYoutubeButton');
        if (filteredVideos.length > 0) {
            watchOnYoutubeButton.classList.remove('disabled')
        } else if (!watchOnYoutubeButton.classList.contains('disabled')) {
            watchOnYoutubeButton.classList.add('disabled')
        }

        changePage(1, true)
    }

    function draw() {
        drawFilters()
        drawFilterResultsContainer()
        drawTable();
        drawTablePagination()
    }

    function removePlayerFilter(type, name) {
        filters[type].splice(filters[type].indexOf(name), 1)
        applyFilters(true)
        draw()
    }

    function removeOpeningFilter(openingName) {
        filters.opening.splice(filters.opening.indexOf(openingName), 1)
        applyFilters(true)
        draw()
    }

    function drawFilters() {
        const filtersContainerElement = document.getElementById("filtersContainer");

        const nodes = []
        filters.anySide.forEach(filter => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-secondary m-1'
            filterSpanElement.textContent = `Any side: ${filter.playerName}`
            if (filter.playerResult) {
                filterSpanElement.textContent += ` | ${filter.playerResult}`
            }
            filterSpanElement.onclick = () => removePlayerFilter("anySide", filter)
            nodes.push(filterSpanElement)
        })

        filters.white.forEach(filter => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-light m-1'
            filterSpanElement.textContent = filter.playerName
            if (filter.playerResult) {
                filterSpanElement.textContent += ` | ${filter.playerResult}`
            }
            filterSpanElement.onclick = () => removePlayerFilter("white", filter)
            nodes.push(filterSpanElement)
        })

        filters.black.forEach(filter => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-dark m-1'
            filterSpanElement.textContent = filter.playerName
            if (filter.playerResult) {
                filterSpanElement.textContent += ` | ${filter.playerResult}`
            }
            filterSpanElement.onclick = () => removePlayerFilter("black", filter)
            nodes.push(filterSpanElement)
        })

        filters.opening.forEach(openingName => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = openingName
            filterSpanElement.onclick = () => removeOpeningFilter(openingName)
            nodes.push(filterSpanElement)
        })

        if (filters.pgnFilter !== "") {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = "PGN: " + filters.pgnFilter
            filterSpanElement.onclick = () => {
                filters.pgnFilter = ""
                if (board) {
                    board.position("start")
                }
                if (game) {
                    game.reset()
                }
                applyFilters(true)
            }
            nodes.push(filterSpanElement)
        }

        if (filters.title !== "") {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = "Title: " + filters.title
            filterSpanElement.onclick = () => {
                filters.title = ""
                document.getElementById('titleInput').value = ""
                applyFilters(true)
            }
            nodes.push(filterSpanElement)
        }

        filters.results.forEach(result => {
            let resultText = ""
            switch (result) {
                case "w":
                    resultText = "white"
                    break
                case "b":
                    resultText = "black"
                    break
                case "d":
                    resultText = "draw"
                    break
                case "na":
                    resultText = "n/a"
                    break
            }

            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = `Result: ${resultText}`
            filterSpanElement.onclick = () => {
                filters.results.splice(filters.results.indexOf(result), 1)
                applyFilters(true)
            }
            nodes.push(filterSpanElement)
        })

        if (filters.b4Played) {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = "White played b4!!!"
            filterSpanElement.onclick = () => {
                filters.b4Played = null
                applyFilters(true)
            }
            nodes.push(filterSpanElement)
        }

        if (filters.multipleGames) {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = "Multiple games in video"
            filterSpanElement.onclick = () => {
                filters.multipleGames = null
                applyFilters(true)
            }
            nodes.push(filterSpanElement)
        }

        let publishedFromValue = document.getElementById('publishedFrom').value
        if (publishedFromValue) {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = `Published >= ${publishedFromValue}`
            filterSpanElement.onclick = () => {
                document.getElementById('publishedFrom').value = ""
                applyFilters(false)
            }
            nodes.push(filterSpanElement)
        }

        let publishedToValue = document.getElementById('publishedTo').value
        if (publishedToValue) {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge text-bg-info m-1'
            filterSpanElement.textContent = `Published <= ${publishedToValue}`
            filterSpanElement.onclick = () => {
                document.getElementById('publishedTo').value = ""
                applyFilters(false)
            }
            nodes.push(filterSpanElement)
        }

        $('#sortBySelect').val(sortBy)
        $('#sortDirectionSelect').val(sortDirection)

        filtersContainerElement.replaceChildren(...nodes)
    }

    function drawFilterResultsContainer() {
        const total = filteredVideos.length
        const withPlayers = filteredVideos.filter(video => video.games[0] && video.games[0].white).length
        document.getElementById("filterResultsContainer").textContent = `Videos: ${total}, with players: ${withPlayers}`;
        const withPgns = filteredVideos.filter(video => _.some(video.games, game => game.pgn)).length
        document.getElementById("filterResultsContainer").textContent += `, with moves: ${withPgns}`;
        const withResults = filteredVideos.filter(video => video.games[0] && video.games[0].result).length
        document.getElementById("filterResultsContainer").textContent += `, with results: ${withResults}`;
    }

    function drawTable() {
        let tableBodyElement = document.getElementById("tableBody");
        let newNodes = filteredVideos.slice((currentPageNumber - 1) * pageSize, (currentPageNumber) * pageSize)
            .map(video => {
                let tableRow = document.createElement("tr");

                let publishedAtCell = document.createElement("th");
                publishedAtCell.textContent = video.date.toISOString()
                publishedAtCell.className = 'd-none d-lg-block'
                tableRow.appendChild(publishedAtCell)

                let titleCell = document.createElement("td");
                titleCell.setAttribute("data-toggle", "tooltip")
                titleCell.setAttribute("data-placement", "top")
                titleCell.setAttribute("title", video.title)
                let titleHref = document.createElement("a");
                titleHref.href = "https://www.youtube.com/watch?v=" + video.id
                titleHref.target = "_blank"
                titleHref.textContent = _.truncate(video.title, {
                    'length': 45,
                    'omission': '...'
                })
                titleCell.appendChild(titleHref)
                tableRow.appendChild(titleCell)

                let whitePlayerCell = document.createElement("td");
                video.games.forEach(game => {
                    let nameCell = document.createElement("div");
                    if (game.white) {
                        nameCell.textContent = _.truncate(game.white, {
                            'length': 40,
                            'omission': '...'
                        })
                    }
                    whitePlayerCell.appendChild(nameCell)
                })
                tableRow.appendChild(whitePlayerCell)

                let blackPlayerCell = document.createElement("td");
                video.games.forEach(game => {
                    let nameCell = document.createElement("div");
                    if (game.white) {
                        nameCell.textContent = _.truncate(game.black, {
                            'length': 40,
                            'omission': '...'
                        })
                    }
                    blackPlayerCell.appendChild(nameCell)
                })
                tableRow.appendChild(blackPlayerCell)

                let yearCell = document.createElement("td");
                yearCell.className = 'table-cell'
                if (video.games && video.games[0] && video.games[0].year) {
                    yearCell.textContent = video.games[0].year
                }
                tableRow.appendChild(yearCell)

                if (showResult) {
                    let resultCell = document.createElement("td");
                    if (video.games && video.games[0] && video.games[0].result) {
                        resultCell.textContent = video.games[0].result
                    }
                    tableRow.appendChild(resultCell)
                }
                return tableRow
            });

        tableBodyElement.replaceChildren(...newNodes)
    }

    function drawTablePagination() {
        let tablePaginationElement = document.getElementById("tablePagination");
        let paginationItems = tablePaginationElement.children
        Array.from(paginationItems).forEach(paginationItem => {
            if (paginationItem.className.indexOf("page-number-selector") > 0) {
                paginationItem.remove()
            }
        })
        // <li class="page-item page-number-selector"><a class="page-link" href="#">1</a></li>
        let pageNumbers = _.range(Math.max(1, currentPageNumber - 10), Math.min(filteredVideos.length / pageSize + 1, currentPageNumber + 10));
        let idxCurrent = pageNumbers.indexOf(currentPageNumber);
        pageNumbers
            .slice(Math.max(idxCurrent - 6, 0), Math.max(idxCurrent - 2, 0) + 9)
            .slice(0, 9)
            .forEach(nr => drawSinglePaginationPage(nr, nr === currentPageNumber))
    }

    function drawSinglePaginationPage(number, active) {
        let tablePaginationElement = document.getElementById("tablePagination");
        let liElement = document.createElement("li");
        liElement.className = "page-item page-number-selector " + (active ? "active" : "")
        let href = document.createElement("a");
        href.textContent = number
        href.className = "page-link text-center"
        href.href = "#"
        href.onclick = ev => changePage(number)
        liElement.appendChild(href)
        tablePaginationElement.insertBefore(liElement, tablePaginationElement.childNodes.item(tablePaginationElement.childNodes.length - 4))
    }

    let game = null
    let board = null

    import {Chess} from 'https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.3/+esm'

    $('#collapsibleBoardFilterButton').on('click', function () {
        if (board == null) {
            loadBoard()
        }
    })

    function loadBoard() {
        game = new Chess()

        function onDragStart(source, piece) {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop
            let scrollLeft = window.pageXOffset || document.documentElement.scrollLeft

            window.onscroll = function () {
                window.scrollTo(scrollLeft, scrollTop);
            };

            setTimeout(function () {
                window.onscroll = function () {
                }
            }, 3000)

            if (game.isGameOver()) return false

            // only pick up pieces for the side to move
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false
            }
        }

        function onDrop(source, target) {
            window.onscroll = function () {
            }

            try {
                game.move({
                    from: source,
                    to: target,
                    promotion: 'q'
                })

                filters.pgnFilter = game.pgn()
                setTimeout(function () {
                    // hack for wrong display of white O-O
                    board.position(game.fen())
                }, 1)
                applyFilters(true)
            } catch (e) {
                return 'snapback'
            }
        }

        const config = {
            draggable: true,
            position: 'start',
            dropOffBoard: 'snapback',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapbackEnd: () => window.onscroll = function () {
            },
            onMoveEnd: () => window.onscroll = function () {
            }
        }

        $('#boardFilter').width(Math.min($("#collapsibleBoardFilter").width(), 400))
        board = Chessboard('boardFilter', config)

        if (filters.pgnFilter) {
            game.loadPgn(filters.pgnFilter)
            board.position(game.fen())
        }
    }
</script>
</body>
</html>
