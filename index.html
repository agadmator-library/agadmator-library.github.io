<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>agadmator-library</title>
    <meta name="description" content="List (library) of all agadmator videos.">
    <meta name="author" content="SitePoint">

    <meta property="og:title" content="agadmator-library">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://agadmator-library.github.io">
    <meta property="og:description" content="List (library) of all agadmator videos.">
    <meta property="og:image" content="image.png">

    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
          integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
</head>
<style>
    .page-number-selector {
        width: 3em
    }

    #openingInput {
        width: 100%;
    }
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MX1CWFQ3KN"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-MX1CWFQ3KN');
</script>

<body>

<div class="container">


    <div class="card mt-2">
        <div class="card-header">
            Filters
            <button class="btn btn-light float-right p-0" type="button" data-toggle="collapse"
                    data-target="#filtersCard" aria-expanded="false" aria-controls="collapseExample">
                &#x21D5;
            </button>
        </div>

        <div class="card-body collapse show" id="filtersCard">
            <form class="form-inline " action="" id="playerNamesFilterForm">
                <label class="sr-only" for="playerSideSelect">Select side</label>
                <select class="form-control mb-2 mr-sm-2 " id="playerSideSelect">
                    <option value="anySide">Any side</option>
                    <option value="white">White</option>
                    <option value="black">Black</option>
                </select>

                <label class="sr-only" for="playerResultSelect">Player result</label>
                <select class="form-control mb-2 mr-sm-2 d-none d-lg-block" id="playerResultSelect">
                    <option value="" selected>Any outcome</option>
                    <option value="won">Won</option>
                    <option value="lost">Lost</option>
                    <option value="draw">Draw</option>
                </select>

                <label class="sr-only" for="playerInput">Player</label>
                <input type="text" class="form-control mb-2 mr-sm-2 basicPlayerAutoComplete flex-fill" id="playerInput"
                       placeholder="Player"
                       autocomplete="off">
            </form>
            <form class="form-inline" action="" id="openingFilterForm">
                <label class="sr-only" for="openingInput">Opening</label>
                <input type="text" class="form-control mb-2 mr-sm-2 openingAutoComplete" id="openingInput"
                       placeholder="Opening"
                       autocomplete="off">
            </form>
            <form class="form-inline" action="" id="titleFilterForm">
                <label class="sr-only" for="openingInput">Title contains</label>
                <input type="text" class="form-control mb-2 mr-sm-2 flex-fill" id="titleInput"
                       placeholder="Title contains"
                       autocomplete="off">
            </form>
            <form class="form-inline" action="" id="resultForm">
                <label class="sr-only" for="resultSelect">Result</label>
                <select class="form-control mb-2 mr-sm-2 " id="resultSelect">
                    <option value="" selected disabled hidden>Result</option>
                    <option value="w">White won</option>
                    <option value="b">Black won</option>
                    <option value="d">Draw</option>
                    <option value="na">n/a</option>
                </select>
                <div class="form-check mb-2 mr-sm-2">
                    <label class="form-check-label" for="b4Check">
                        White played b4!!!
                    </label>
                    <input class="form-check-input ml-2" type="checkbox" id="b4Check">
                </div>
            </form>
            <form class="form-inline" action="" id="sortByForm">
                <label class="my-1 mr-2" for="sortBySelect">Sort by</label>
                <select class="form-control mb-2 mr-sm-2 " id="sortBySelect">
                    <option value="date">Published at</option>
                    <option value="title">Title</option>
                    <option value="w">Player white</option>
                    <option value="b">Player black</option>
                    <option value="year">Year</option>
                </select>
                <label class="sr-only" for="sortDirectionSelect">Sorting direction</label>
                <select class="form-control mb-2 mr-sm-2 " id="sortDirectionSelect">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </form>
            <div>
                <a class="btn btn-primary" data-toggle="collapse" href="#collapsibleBoardFilter" role="button"
                   id="collapsibleBoardFilterButton" aria-expanded="false" aria-controls="collapsibleBoardFilter">
                    Filter by playing moves
                </a>
                <div class="collapse mt-1 ml-4" id="collapsibleBoardFilter" style="width: 100%">
                    <form class="form-inline" action="" id="transpositionForm">
                        <div class="form-check mb-2 mr-sm-2">
                            <label class="form-check-label" for="transpositionCheck">
                                Include transpositions
                            </label>
                            <input class="form-check-input ml-2" type="checkbox" id="transpositionCheck">
                        </div>
                    </form>
                    <div id="boardFilter">
                    </div>
                    <a class="btn btn-primary mt-1" role="button" id="backOneStep">
                        Back one step
                    </a>
                </div>

            </div>
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-header">
            Filters applied
            <button class="btn btn-light float-right p-0" type="button" data-toggle="collapse"
                    data-target="#filtersContainerBody" aria-expanded="false" aria-controls="filtersContainerBody">
                &#x21D5;
            </button>
        </div>

        <div class="card-body collapse show" id="filtersContainerBody">
            <div id="filtersContainer">
            </div>
            <button id="clearFilterButton" type="submit" class="btn btn-primary float-right">Clear filters
            </button>

        </div>
        <div id="filterResultsContainer" class="card-footer text-muted pl-3 pt-1 pb-1"
             data-toggle="tooltip"
             data-placement="top"
             title="'with players' are videos with players names present. 'with moves' are videos eligible for opening and PGN filter.">
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-body">
            <div class="btn-group btn-group-sm" role="group">
                <button id="watchTopOnYoutubeButton" class="btn btn-primary mr-2" data-container="body"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Opens YouTube playlist with top filtered videos (up to 50).">
                    Watch top 50 on YouTube
                </button>
                <button id="watchOnYoutubeButton" class="btn btn-primary mr-2" data-container="body"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Opens YouTube playlist with currently visible (page) videos.">
                    Watch visible on YouTube
                </button>
                <button id="showResultButton" class="btn btn-primary mr-2" data-container="body">
                    Show result column
                </button>
                <button id="hideResultButton" class="btn btn-primary mr-2" style="display: none" data-container="body">
                    Hide result column
                </button>
            </div>
        </div>
    </div>


    <div class="table-responsive mt-1">
        <table class="table table-sm table-hover table-striped">
            <thead>
            <tr>
                <th class="d-none d-lg-block" scope="col">Published at</th>
                <th scope="col">Title</th>
                <th scope="col">White</th>
                <th scope="col">Black</th>
                <th class="d-none d-lg-table-cell" scope="col">Year</th>
                <th scope="col" id="resultColumnHeader" style="display: none">Result</th>
            </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <nav>
        <ul class="pagination justify-content-center" id="tablePagination">
            <li id="firstPageLink" class="page-item">
                <span class="sr-only">First</span>
                <span class="page-link">&laquo;</span>
            </li>
            <li id="previousPageLink" class="page-item">
                <a class="page-link" href="#">
                    <span aria-hidden="true">‹</span>
                    <span class="sr-only">Previous</span>
                </a>
            </li>
            <li id="nextPageLink" class="page-item">
                <a class="page-link" href="#">
                    <span aria-hidden="true">›</span>
                    <span class="sr-only">Next</span>
                </a>
            </li>
            <li id="lastPageLink" class="page-item">
                <span class="sr-only">Last</span>
                <span class="page-link">&raquo;</span>
            </li>
        </ul>
    </nav>

</div>


<footer class="page-footer font-small indigo">

    <div class="footer-copyright text-center py-3">This is only a fun project and not everything is properly parsed. Do
        not trust entirely.
    </div>
    <div class="footer-copyright text-center py-3">Report missing/invalid data by creating an issue on <a
            href="https://github.com/agadmator-library/agadmator-library.github.io/issues" target="_blank">GitHub</a> or
        by writing <a href="https://twitter.com" target="_blank">Twitter</a> post with phrase 'agadmator-library'. Do
        not forget to add YouTube url
    </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
        integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
        crossorigin="anonymous"></script>
<script defer src="js/chessboard-1.0.0.min.js"></script>
<script type="module">
    class Game {
        constructor(white, black, result, year) {
            this.white = white
            this.black = black
            this.result = result
            this.year = year
        }
    }

    class Video {
        constructor(id, date, title, game) {
            this.id = id
            this.title = title
            this.date = date
            this.game = game
        }

        getWhite() {
            return this.game ? this.game.white : null
        }

        getBlack() {
            return this.game ? this.game.black : null
        }

        getWhiteOrEmpty() {
            return _.defaultTo(this.getWhite(), "")
        }

        getBlackOrEmpty() {
            return _.defaultTo(this.getBlack(), "")
        }
    }

    let currentPageNumber = 1 // 1-based
    let pageSize = 30
    let videos = []
    let filteredVideos = []
    /**
     * Stores all player names with number of occurences
     * @type {*[]}
     */
    let players = []
    let filters = {
        anySide: [],
        white: [],
        black: [],
        opening: [],
        results: [],
        pgnFilter: "",
        title: "",
        b4Played: null
    }
    let openings = []
    let videosPgns = {}
    let positions = {}
    let b4 = []
    let sortBy = "date"
    let sortDirection = "desc"
    let showResult = false

    $("#playerNamesFilterForm").on('submit', function (event) {
        event.preventDefault();
    });
    $("#openingFilterForm").on('submit', function (event) {
        event.preventDefault();
    });
    $(".page-link").on('click', function (event) {
        event.preventDefault();
    });
    $("#firstPageLink").on('click', () => changePage(1))
    $("#previousPageLink").on('click', () => {
        if (currentPageNumber > 1) {
            changePage(currentPageNumber - 1)
        }
    })
    $('#nextPageLink').on('click', () => {
        if (currentPageNumber < filteredVideos.length / pageSize) {
            changePage(currentPageNumber + 1)
        }
    })
    $("#lastPageLink").on('click', () => {
        changePage(parseInt(filteredVideos.length / pageSize) + 1)
    })

    $("#playerInput").on('autocomplete.select ', function (event, item) {
        const side = document.getElementById('playerSideSelect').value
        const filter = {
            playerName: item,
            playerResult: document.getElementById('playerResultSelect').value,
            testWhite: function (video) {
                return video.getWhiteOrEmpty().toLowerCase() === this.playerName.toLowerCase()
                    && (this.playerResult === "" || (video.game.result && (
                        video.game.result === "w" && this.playerResult === "won"
                        || video.game.result === "b" && this.playerResult === "lost"
                        || video.game.result === "d" && this.playerResult === "draw"
                    )))
            },
            testBlack: function (video) {
                return video.getBlackOrEmpty().toLowerCase() === this.playerName.toLowerCase()
                    && (this.playerResult === "" || (video.game.result && (
                        video.game.result === "w" && this.playerResult === "lost"
                        || video.game.result === "b" && this.playerResult === "won"
                        || video.game.result === "d" && this.playerResult === "draw"
                    )))
            }
        }
        filters[side].push(filter)

        applyFilters()

        setTimeout(function () {
            document.getElementById('playerSideSelect').value = "anySide"
            document.getElementById('playerInput').value = ""
            document.getElementById('playerResultSelect').value = ""
        }, 1)

    })

    $("#openingInput").on('autocomplete.select ', function (event, item) {
        filters.opening.push(item)

        applyFilters()

        setTimeout(function () {
            document.getElementById('openingInput').value = ""
        }, 1)
    })

    document.getElementById('titleInput').addEventListener('input', event => {
        filters.title = event.target.value
        applyFilters()
    })

    $("#clearFilterButton").on('click', clearFilters)

    $("#backOneStep").on('click', function () {
        game.undo()
        board.position(game.fen())
        filters.pgnFilter = game.pgn() ? game.pgn() : ""
        applyFilters()
    })

    $('#sortBySelect').change(function () {
        sortBy = $(this).val()
        applyFilters()
    })

    $('#sortDirectionSelect').change(function () {
        sortDirection = $(this).val()
        applyFilters()
    })

    $('#resultSelect').change(function () {
        if (filters.results.indexOf($(this).val()) < 0) {
            filters.results.push($(this).val())
        }
        applyFilters()
        setTimeout(function () {
            document.getElementById('resultSelect').value = ""
        }, 1)
    })

    $('#b4Check').change(function () {
        if ($(this).prop("checked")) {
            filters.b4Played = true
        } else {
            filters.b4Played = null
        }
        $(this).prop("checked", false)
        applyFilters()
    })

    $('#transpositionCheck').change(function () {
        if (filters.pgnFilter) {
            applyFilters()
        }
    })

    function watchIdsOnYoutube(ids) {
        if (ids === "") {
            return
        }
        const url = `https://www.youtube.com/watch_videos?video_ids=${ids}`
        window.open(url, '_blank').focus();
    }

    $('#watchTopOnYoutubeButton').on('click', function () {
        const ids = filteredVideos.slice(0, 50)
            .map(video => video.id)
            .join(",");
        watchIdsOnYoutube(ids);
    })

    $('#watchOnYoutubeButton').on('click', function () {
        const ids = filteredVideos.slice((currentPageNumber - 1) * pageSize, (currentPageNumber) * pageSize)
            .map(video => video.id)
            .join(",");
        watchIdsOnYoutube(ids)
    })

    $('#showResultButton').on('click', function () {
        showResult = true
        $('#resultColumnHeader').css("display", "table-cell");
        $('#showResultButton').css("display", "none")
        $('#hideResultButton').css("display", "block")
        draw()
    })

    $('#hideResultButton').on('click', function () {
        showResult = false
        $('#resultColumnHeader').css("display", "none");
        $('#showResultButton').css("display", "block")
        $('#hideResultButton').css("display", "none")
        draw()
    })

    fetch("generated/db.json")
        .then(res => res.json())
        .then(res => {
            function decodeResult(result) {
                switch (result) {
                    case 1:
                        return "w"
                    case 0:
                        return "d"
                    case -1:
                        return "b"
                    default:
                        return null
                }
            }

            const toTyped = res.videos.map(dbVideo => {
                let game = dbVideo.g
                    ? new Game(res.players[dbVideo.g.w], res.players[dbVideo.g.b], decodeResult(dbVideo.g.r), dbVideo.g.y)
                    : null;
                return new Video(dbVideo.id, new Date(dbVideo.d * 1000), dbVideo.t, game)
            })

            videos = filteredVideos = _.orderBy(toTyped, ["date"], ["desc"])

            let tmpPlayerNames = {}
            videos.filter(video => video.game)
                .forEach(video => {
                    tmpPlayerNames[video.getWhite()] = tmpPlayerNames[video.getWhite()] ? tmpPlayerNames[video.getWhite()] + 1 : 1
                    tmpPlayerNames[video.getBlack()] = tmpPlayerNames[video.getBlack()] ? tmpPlayerNames[video.getBlack()] + 1 : 1
                })
            players = _.orderBy(Object.keys(tmpPlayerNames)
                .map(name => {
                    return {
                        name: name,
                        count: tmpPlayerNames[name]
                    }
                }), ["count", "name"], ["desc", "asc"])

        })
        .then(value => changePage(1, true))

    fetch("generated/pgns.json")
        .then(res => res.json())
        .then(res => videosPgns = res)
        .then(() => drawFilterResultsContainer())

    fetch("generated/positions.json")
        .then(res => res.json())
        .then(res => {
            positions = res
            positions.videos.forEach((videoId, positionIndex) => videos.find(video => video.id === videoId).positionIndex = positionIndex)
        })

    fetch("generated/openings-slim.json")
        .then(res => res.json())
        .then(res => openings = res)

    fetch("generated/b4.json")
        .then(res => res.json())
        .then(res => b4 = res)
        .then(() => drawFilterResultsContainer())

    function changePage(number, forbidScroll) {
        currentPageNumber = number
        draw()

        if (!forbidScroll) {
            setTimeout(function () {
                document.getElementById("lastPageLink").scrollIntoView()
            }, 10)
        }
    }

    function clearFilters() {
        filters = {
            anySide: [],
            white: [],
            black: [],
            opening: [],
            results: [],
            pgnFilter: "",
            title: "",
            b4Played: null
        }
        if (board) {
            board.position("start")
            game.reset()
        }
        document.getElementById('titleInput').value = ""
        applyFilters()
    }

    function applyFilters() {
        const pgnPrefixes = openings
            .filter(opening => _.some(filters.opening, filterOpening => opening.name === filterOpening))
            .map(opening => opening.moves)
        const includeTranspositions = document.getElementById('transpositionCheck').checked
        filteredVideos = videos
            .filter(video => {
                if (filters.anySide.length === 0) {
                    return true
                } else {
                    return _.some(filters.anySide, filter => filter.testWhite(video) || filter.testBlack(video))
                }
            })
            .filter(video => {
                if (filters.white.length === 0) {
                    return true
                } else {
                    return _.some(filters.white, filter => filter.testWhite(video))
                }
            })
            .filter(video => {
                if (filters.black.length === 0) {
                    return true
                } else {
                    return _.some(filters.black, filter => filter.testBlack(video))
                }
            })
            .filter(video => {
                if (pgnPrefixes.length === 0) {
                    return true
                }

                const videoPgn = videosPgns[video.id]
                if (!videoPgn) {
                    return false
                }

                return _.some(pgnPrefixes, pgnPrefix => videoPgn.indexOf(pgnPrefix) === 0)
            })
            .filter(video => {
                if (filters.pgnFilter === "") {
                    return true
                }

                const videoPgn = videosPgns[video.id]
                if (!videoPgn) {
                    return false
                }

                return videoPgn.indexOf(filters.pgnFilter) === 0
                    || includeTranspositions && positions && positions[game.fen().replaceAll(/ - \d+ \d+/g, "")] && positions[game.fen().replaceAll(/ - \d+ \d+/g, "")].includes(video.positionIndex)
            })
            .filter(video => {
                if (!filters.title) {
                    return true
                }

                return video.title.toLowerCase().includes(filters.title.toLowerCase())
            })
            .filter(video => {
                if (filters.results.length === 0) {
                    return true
                } else {
                    const videoResult = video.game ? video.game.result : null
                    return filters.results.indexOf(videoResult) >= 0 || !videoResult && filters.results.indexOf("na") >= 0
                }
            })
            .filter(video => {
                if (!filters.b4Played) {
                    return true
                }

                return b4.length === 0 || b4.indexOf(video.id) >= 0
            })

        filteredVideos = _.sortBy(filteredVideos, function (video) {
            if (sortBy === "date") {
                return video.date
            } else if (sortBy === "title") {
                return video.title.replaceAll(/[^\p{L}\d -]/gu, "").toLowerCase()
            } else if (sortBy === "w") {
                return video.getWhiteOrEmpty().toLowerCase()
            } else if (sortBy === "b") {
                return video.getBlackOrEmpty().toLowerCase()
            } else if (sortBy === "year") {
                return video.game && video.game.year ? video.game.year : ""
            } else {
                return ""
            }
        })
        if (sortDirection === "desc") {
            filteredVideos.reverse()
        }

        let watchOnYoutubeButton = document.getElementById('watchOnYoutubeButton');
        if (filteredVideos.length > 0) {
            watchOnYoutubeButton.classList.remove('disabled')
        } else if (!watchOnYoutubeButton.classList.contains('disabled')) {
            watchOnYoutubeButton.classList.add('disabled')
        }

        changePage(1, true)
    }

    function draw() {
        drawFilters()
        drawFilterResultsContainer()
        drawTable();
        drawTablePagination()
    }

    function removePlayerFilter(type, name) {
        filters[type].splice(filters[type].indexOf(name), 1)
        applyFilters()
        draw()
    }

    function removeOpeningFilter(openingName) {
        filters.opening.splice(filters.opening.indexOf(openingName), 1)
        applyFilters()
        draw()
    }

    function drawFilters() {
        const filtersContainerElement = document.getElementById("filtersContainer");

        const nodes = []
        filters.anySide.forEach(filter => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-secondary ml-1 mr-1'
            filterSpanElement.textContent = `Any side: ${filter.playerName}`
            if (filter.playerResult) {
                filterSpanElement.textContent += ` | ${filter.playerResult}`
            }
            filterSpanElement.onclick = () => removePlayerFilter("anySide", filter)
            nodes.push(filterSpanElement)
        })

        filters.white.forEach(filter => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-light ml-1 mr-1'
            filterSpanElement.textContent = filter.playerName
            if (filter.playerResult) {
                filterSpanElement.textContent += ` | ${filter.playerResult}`
            }
            filterSpanElement.onclick = () => removePlayerFilter("white", filter)
            nodes.push(filterSpanElement)
        })

        filters.black.forEach(filter => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-dark ml-1 mr-1'
            filterSpanElement.textContent = filter.playerName
            if (filter.playerResult) {
                filterSpanElement.textContent += ` | ${filter.playerResult}`
            }
            filterSpanElement.onclick = () => removePlayerFilter("black", filter)
            nodes.push(filterSpanElement)
        })

        filters.opening.forEach(openingName => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = openingName
            filterSpanElement.onclick = () => removeOpeningFilter(openingName)
            nodes.push(filterSpanElement)
        })

        if (filters.pgnFilter !== "") {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = "PGN: " + filters.pgnFilter
            filterSpanElement.onclick = () => {
                filters.pgnFilter = ""
                board.position("start")
                game.reset()
                applyFilters()
            }
            nodes.push(filterSpanElement)
        }

        if (filters.title !== "") {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = "Title: " + filters.title
            filterSpanElement.onclick = () => {
                filters.title = ""
                document.getElementById('titleInput').value = ""
                applyFilters()
            }
            nodes.push(filterSpanElement)
        }

        filters.results.forEach(result => {
            let resultText = ""
            switch (result) {
                case "w":
                    resultText = "white"
                    break
                case "b":
                    resultText = "black"
                    break
                case "d":
                    resultText = "draw"
                    break
                case "na":
                    resultText = "n/a"
                    break
            }

            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = `Result: ${resultText}`
            filterSpanElement.onclick = () => {
                filters.results.splice(filters.results.indexOf(result), 1)
                applyFilters()
            }
            nodes.push(filterSpanElement)
        })

        if (filters.b4Played) {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = "White played b4!!!"
            filterSpanElement.onclick = () => {
                filters.b4Played = null
                applyFilters()
            }
            nodes.push(filterSpanElement)
        }

        $('#sortBySelect').val(sortBy)
        $('#sortDirectionSelect').val(sortDirection)

        filtersContainerElement.replaceChildren(...nodes)
    }

    function drawFilterResultsContainer() {
        const total = filteredVideos.length
        const withPlayers = filteredVideos.filter(video => video.getWhite()).length
        document.getElementById("filterResultsContainer").textContent = `Videos: ${total}, with players: ${withPlayers}`;
        if (Object.keys(videosPgns).length > 0) {
            const withPgns = filteredVideos.filter(video => videosPgns[video.id]).length
            document.getElementById("filterResultsContainer").textContent += `, with moves: ${withPgns}`;
        }
        const withResults = filteredVideos.filter(video => video.game && video.game.result).length
        document.getElementById("filterResultsContainer").textContent += `, with results: ${withResults}`;
    }

    function drawTable() {
        let tableBodyElement = document.getElementById("tableBody");
        let newNodes = filteredVideos.slice((currentPageNumber - 1) * pageSize, (currentPageNumber) * pageSize)
            .map(video => {
                let tableRow = document.createElement("tr");

                let publishedAtCell = document.createElement("th");
                publishedAtCell.textContent = video.date.toISOString()
                publishedAtCell.className = 'd-none d-lg-block'
                tableRow.appendChild(publishedAtCell)

                let titleCell = document.createElement("td");
                let titleHref = document.createElement("a");
                titleHref.href = "https://www.youtube.com/watch?v=" + video.id
                titleHref.target = "_blank"
                titleHref.textContent = _.truncate(video.title, {
                    'length': 45,
                    'omission': '...'
                })
                titleCell.appendChild(titleHref)
                tableRow.appendChild(titleCell)

                let whitePlayerCell = document.createElement("td");
                if (video.getWhite()) {
                    whitePlayerCell.textContent = _.truncate(video.getWhite(), {
                        'length': 40,
                        'omission': '...'
                    })
                }
                tableRow.appendChild(whitePlayerCell)

                let blackPlayerCell = document.createElement("td");
                if (video.getBlack()) {
                    blackPlayerCell.textContent = _.truncate(video.getBlack(), {
                        'length': 40,
                        'omission': '...'
                    })
                }
                tableRow.appendChild(blackPlayerCell)

                let yearCell = document.createElement("td");
                yearCell.className = 'd-none d-lg-table-cell'
                if (video.game && video.game.year) {
                    yearCell.textContent = video.game.year
                }
                tableRow.appendChild(yearCell)

                if (showResult) {
                    let resultCell = document.createElement("td");
                    if (video.game && video.game.result) {
                        resultCell.textContent = video.game.result
                    }
                    tableRow.appendChild(resultCell)
                }
                return tableRow
            });

        tableBodyElement.replaceChildren(...newNodes)
    }

    function drawTablePagination() {
        let tablePaginationElement = document.getElementById("tablePagination");
        let paginationItems = tablePaginationElement.children
        Array.from(paginationItems).forEach(paginationItem => {
            if (paginationItem.className.indexOf("page-number-selector") > 0) {
                paginationItem.remove()
            }
        })
        // <li class="page-item page-number-selector"><a class="page-link" href="#">1</a></li>
        let pageNumbers = _.range(Math.max(1, currentPageNumber - 10), Math.min(filteredVideos.length / pageSize + 1, currentPageNumber + 10));
        let idxCurrent = pageNumbers.indexOf(currentPageNumber);
        pageNumbers
            .slice(Math.max(idxCurrent - 6, 0), Math.max(idxCurrent - 2, 0) + 9)
            .slice(0, 9)
            .forEach(nr => drawSinglePaginationPage(nr, nr === currentPageNumber))
    }

    function drawSinglePaginationPage(number, active) {
        let tablePaginationElement = document.getElementById("tablePagination");
        let liElement = document.createElement("li");
        liElement.className = "page-item page-number-selector " + (active ? "active" : "")
        let href = document.createElement("a");
        href.textContent = number
        href.className = "page-link text-center"
        href.href = "#"
        href.onclick = ev => changePage(number)
        liElement.appendChild(href)
        tablePaginationElement.insertBefore(liElement, tablePaginationElement.childNodes.item(tablePaginationElement.childNodes.length - 4))
    }

    $('.basicPlayerAutoComplete').autoComplete({
        resolver: 'custom',
        minLength: 2,
        events: {
            search: function (qry, callback) {
                let searchResult = players
                    .filter(player => player.name.toLowerCase().indexOf(qry.toLowerCase()) >= 0)
                    .map(player => player.name);
                callback(searchResult)
            }
        }
    })

    $('.openingAutoComplete').autoComplete({
        resolver: 'custom',
        minLength: 2,
        events: {
            search: function (qry, callback) {
                let searchResult = openings
                    .filter(opening => opening.name.toLowerCase().indexOf(qry.toLowerCase()) >= 0)
                    .map(opening => opening.name)
                callback(searchResult)
            }
        }
    })

    let game = null
    let board = null

    import {Chess} from 'https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.3/+esm'

    $('#collapsibleBoardFilterButton').on('click', function () {
        if (board == null) {
            loadBoard()
        }
    })

    function loadBoard() {
        game = new Chess()

        function onDragStart(source, piece) {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop
            let scrollLeft = window.pageXOffset || document.documentElement.scrollLeft

            window.onscroll = function () {
                window.scrollTo(scrollLeft, scrollTop);
            };

            setTimeout(function () {
                window.onscroll = function () {
                }
            }, 3000)

            if (game.isGameOver()) return false

            // only pick up pieces for the side to move
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false
            }
        }

        function onDrop(source, target) {
            window.onscroll = function () {
            }

            try {
                game.move({
                    from: source,
                    to: target,
                    promotion: 'q'
                })

                filters.pgnFilter = game.pgn()
                setTimeout(function () {
                    // hack for wrong display of white O-O
                    board.position(game.fen())
                }, 1)
                applyFilters()
            } catch (e) {
                return 'snapback'
            }
        }

        const config = {
            draggable: true,
            position: 'start',
            dropOffBoard: 'snapback',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapbackEnd: () => window.onscroll = function () {
            },
            onMoveEnd: () => window.onscroll = function () {
            }
        }

        $('#boardFilter').width(Math.min($("#collapsibleBoardFilter").width(), 400))
        board = Chessboard('boardFilter', config)
    }
</script>
</body>
</html>
