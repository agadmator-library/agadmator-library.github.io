<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>agadmator-library</title>
    <meta name="description" content="List (library) of all agadmator videos.">
    <meta name="author" content="SitePoint">

    <meta property="og:title" content="agadmator-library">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://agadmator-library.github.io">
    <meta property="og:description" content="List (library) of all agadmator videos.">
    <meta property="og:image" content="image.png">

    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
          integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
</head>
<style>
    .page-number-selector {
        width: 3em
    }

    #openingInput {
        width: 100%;
    }
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MX1CWFQ3KN"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-MX1CWFQ3KN');
</script>

<body>

<div class="container">


    <div class="card mt-2">
        <div class="card-header">
            Filters
        </div>

        <div class="card-body">
            <form class="form-inline " action="" id="playerNamesFilterForm">
                <label class="sr-only" for="playerSideSelect">Select side</label>
                <select class="form-control mb-2 mr-sm-2 " id="playerSideSelect">
                    <option value="anySide">Any side</option>
                    <option value="white">White</option>
                    <option value="black">Black</option>
                </select>


                <label class="sr-only" for="playerInput">Player</label>
                <input type="text" class="form-control mb-2 mr-sm-2 basicPlayerAutoComplete flex-fill" id="playerInput"
                       placeholder="Player"
                       autocomplete="off">

            </form>
            <form class="form-inline" action="" id="openingFilterForm">
                <label class="sr-only" for="openingInput">Opening</label>
                <input type="text" class="form-control mb-2 mr-sm-2 openingAutoComplete" id="openingInput"
                       placeholder="Opening"
                       autocomplete="off">
            </form>
            <form class="form-inline" action="" id="sortByForm">
                <label class="my-1 mr-2" for="sortBySelect">Sort by</label>
                <select class="form-control mb-2 mr-sm-2 " id="sortBySelect">
                    <option value="date">Published at</option>
                    <option value="title">Title</option>
                    <option value="w">Player white</option>
                    <option value="b">Player black</option>
                </select>
                <label class="sr-only" for="sortDirectionSelect">Sorting direction</label>
                <select class="form-control mb-2 mr-sm-2 " id="sortDirectionSelect">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </form>
            <div>
                <a class="btn btn-primary" data-toggle="collapse" href="#collapsibleBoardFilter" role="button"
                   id="collapsibleBoardFilterButton" aria-expanded="false" aria-controls="collapsibleBoardFilter">
                    Filter by playing moves
                </a>
                <div class="collapse mt-1 ml-4" id="collapsibleBoardFilter" style="width: 100%">
                    <div id="boardFilter">
                    </div>
                    <a class="btn btn-primary mt-1" role="button" id="backOneStep">
                        Back one step
                    </a>
                </div>

            </div>
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-header">
            Filters applied
        </div>

        <div class="card-body">
            <div id="filtersContainer">
            </div>
            <button id="clearFilterButton" type="submit" class="btn btn-primary float-right">Clear filters
            </button>

        </div>
        <div id="filterResultsContainer" class="card-footer text-muted pl-3 pt-1 pb-1">
        </div>
    </div>

    <div class="card mt-2">
        <div class="card-body">
            <div class="btn-group btn-group-sm" role="group">
                <button id="watchTopOnYoutubeButton" class="btn btn-primary mr-2" data-container="body"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Opens YouTube playlist with top filtered videos (up to 50).">
                    Watch top 50 on YouTube
                </button>
                <button id="watchOnYoutubeButton" class="btn btn-primary" data-container="body"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Opens YouTube playlist with currently visible (page) videos.">
                    Watch visible on YouTube
                </button>
            </div>
        </div>
    </div>


    <div class="table-responsive mt-1">
        <table class="table table-sm table-hover table-striped">
            <thead>
            <tr>
                <th class="d-none d-lg-block" scope="col">Published at</th>
                <th scope="col">Title</th>
                <th scope="col">White</th>
                <th scope="col">Black</th>
            </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <nav>
        <ul class="pagination justify-content-center" id="tablePagination">
            <li id="firstPageLink" class="page-item">
                <a class="page-link" href="#">First
                </a>
            </li>
            <li id="previousPageLink" class="page-item">
                <a class="page-link" href="#">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
            </li>
            <li id="nextPageLink" class="page-item">
                <a class="page-link" href="#">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
            </li>
            <li id="lastPageLink" class="page-item">
                <a class="page-link" href="#">Last
                </a>
            </li>
        </ul>
    </nav>

</div>


<footer class="page-footer font-small indigo">

    <div class="footer-copyright text-center py-3">This is only a fun project and not everything is properly parsed. Do
        not trust entirely.
    </div>
    <div class="footer-copyright text-center py-3">Report missing/invalid data by creating an issue on <a
            href="https://github.com/agadmator-library/agadmator-library.github.io/issues" target="_blank">GitHub</a> or
        by writing <a href="https://twitter.com" target="_blank">Twitter</a> post with phrase 'agadmator-library'. Do
        not forget to add YouTube url
    </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script defer src="js/chessboard-1.0.0.min.js"></script>
<script type="module">
    class Game {
        constructor(white, black) {
            this.white = white
            this.black = black
        }
    }

    class Video {
        constructor(id, date, title, game) {
            this.id = id
            this.title = title
            this.date = date
            this.game = game
        }

        getWhite() {
            return this.game ? this.game.white : null
        }

        getBlack() {
            return this.game ? this.game.black : null
        }

        getWhiteOrEmpty() {
            return _.defaultTo(this.getWhite(), "")
        }

        getBlackOrEmpty() {
            return _.defaultTo(this.getBlack(), "")
        }
    }

    let currentPageNumber = 1 // 1-based
    let pageSize = 30
    let videos = []
    let filteredVideos = []
    /**
     * Stores all player names with number of occurences
     * @type {*[]}
     */
    let players = []
    let filters = {
        anySide: [],
        white: [],
        black: [],
        opening: [],
        pgnFilter: ""
    }
    let openings = []
    let videosPgns = {}
    let sortBy = "date"
    let sortDirection = "desc"

    $("#playerNamesFilterForm").on('submit', function (event) {
        event.preventDefault();
    });
    $("#openingFilterForm").on('submit', function (event) {
        event.preventDefault();
    });
    $(".page-link").on('click', function (event) {
        event.preventDefault();
    });
    $("#firstPageLink").on('click', () => changePage(1))
    $("#previousPageLink").on('click', () => {
        if (currentPageNumber > 1) {
            changePage(currentPageNumber - 1)
        }
    })
    $('#nextPageLink').on('click', () => {
        if (currentPageNumber < filteredVideos.length / pageSize) {
            changePage(currentPageNumber + 1)
        }
    })
    $("#lastPageLink").on('click', () => {
        changePage(parseInt(filteredVideos.length / pageSize) + 1)
    })

    $("#playerInput").on('autocomplete.select ', function (event, item) {
        const side = document.getElementById('playerSideSelect').value
        filters[side].push(item)

        applyFilters()

        setTimeout(function () {
            document.getElementById('playerSideSelect').value = "anySide"
            document.getElementById('playerInput').value = ""
        }, 1)

    })

    $("#openingInput").on('autocomplete.select ', function (event, item) {
        filters.opening.push(item)

        applyFilters()

        setTimeout(function () {
            document.getElementById('openingInput').value = ""
        }, 1)
    })

    $("#clearFilterButton").on('click', clearFilters)

    $("#backOneStep").on('click', function () {
        game.undo()
        board.position(game.fen())
        filters.pgnFilter = game.pgn() ? game.pgn() : ""
        applyFilters()
    })

    $('#sortBySelect').change(function () {
        sortBy = $(this).val()
        applyFilters()
    })

    $('#sortDirectionSelect').change(function () {
        sortDirection = $(this).val()
        applyFilters()
    })

    function watchIdsOnYoutube(ids) {
        if (ids === "") {
            return
        }
        const url = `https://www.youtube.com/watch_videos?video_ids=${ids}`
        window.open(url, '_blank').focus();
    }

    $('#watchTopOnYoutubeButton').on('click', function () {
        const ids = filteredVideos.slice(0, 50)
            .map(video => video.id)
            .join(",");
        watchIdsOnYoutube(ids);
    })

    $('#watchOnYoutubeButton').on('click', function () {
        const ids = filteredVideos.slice((currentPageNumber - 1) * pageSize, (currentPageNumber) * pageSize)
            .map(video => video.id)
            .join(",");
        watchIdsOnYoutube(ids)
    })

    fetch("db.json")
        .then(res => res.json())
        .then(res => {
            const toTyped = res.map(dbVideo => {
                return new Video(dbVideo.id, dbVideo.date, dbVideo.title, dbVideo.game ? new Game(dbVideo.game.w, dbVideo.game.b) : null)
            })

            videos = filteredVideos = _.orderBy(toTyped, ["date"], ["desc"])

            let tmpPlayerNames = {}
            videos.filter(video => video.game)
                .forEach(video => {
                    tmpPlayerNames[video.getWhite()] = tmpPlayerNames[video.getWhite()] ? tmpPlayerNames[video.getWhite()] + 1 : 1
                    tmpPlayerNames[video.getBlack()] = tmpPlayerNames[video.getBlack()] ? tmpPlayerNames[video.getBlack()] + 1 : 1
                })
            players = _.orderBy(Object.keys(tmpPlayerNames)
                .map(name => {
                    return {
                        name: name,
                        count: tmpPlayerNames[name]
                    }
                }), ["count", "name"], ["desc", "asc"])

        })
        .then(value => changePage(1, true))

    fetch("pgns.json")
        .then(res => res.json())
        .then(res => videosPgns = res)

    fetch("openings-slim.json")
        .then(res => res.json())
        .then(res => openings = res)


    function changePage(number, forbidScroll) {
        currentPageNumber = number
        draw()

        if (!forbidScroll) {
            setTimeout(function () {
                document.getElementById("lastPageLink").scrollIntoView()
            }, 10)
        }
    }

    function clearFilters() {
        filters = {
            anySide: [],
            white: [],
            black: [],
            opening: [],
            pgnFilter: ""
        }
        if (board) {
            board.position("start")
            game.reset()
        }
        applyFilters()
    }

    function applyFilters() {
        const pgnPrefixes = openings
            .filter(opening => _.some(filters.opening, filterOpening => opening.name === filterOpening))
            .map(opening => opening.moves)

        filteredVideos = videos
            .filter(video => {
                if (filters.anySide.length === 0) {
                    return true
                } else {
                    const gameW = video.getWhiteOrEmpty().toLowerCase()
                    const gameB = video.getBlackOrEmpty().toLowerCase()
                    return _.some(filters.anySide, nameFromFilter =>
                        gameW.indexOf(nameFromFilter.toLowerCase()) >= 0 || gameB.indexOf(nameFromFilter.toLowerCase()) >= 0)
                }
            })
            .filter(video => {
                if (filters.white.length === 0) {
                    return true
                } else {
                    const gameW = video.getWhiteOrEmpty().toLowerCase()
                    return _.some(filters.white, nameFromFilter => gameW.indexOf(nameFromFilter.toLowerCase()) >= 0)
                }
            })
            .filter(video => {
                if (filters.black.length === 0) {
                    return true
                } else {
                    const gameB = video.getBlackOrEmpty().toLowerCase()
                    return _.some(filters.black, nameFromFilter => gameB.indexOf(nameFromFilter.toLowerCase()) >= 0)
                }
            })
            .filter(video => {
                if (pgnPrefixes.length === 0) {
                    return true
                }

                const videoPgn = videosPgns[video.id]
                if (!videoPgn) {
                    return false
                }

                return _.some(pgnPrefixes, pgnPrefix => videoPgn.indexOf(pgnPrefix) === 0)
            })
            .filter(video => {
                if (filters.pgnFilter === "") {
                    return true
                }

                const videoPgn = videosPgns[video.id]
                if (!videoPgn) {
                    return false
                }

                return videoPgn.indexOf(filters.pgnFilter) === 0
            })

        filteredVideos = _.sortBy(filteredVideos, function (video) {
            if (sortBy === "date") {
                return video.date
            } else if (sortBy === "title") {
                return video.title.replaceAll(/[^\p{L}\d -]/gu, "").toLowerCase()
            } else if (sortBy === "w") {
                return _.defaultTo(video.getWhite(), "").toLowerCase()
            } else if (sortBy === "b") {
                return _.defaultTo(video.getBlack(), "").toLowerCase()
            } else {
                return ""
            }
        })
        if (sortDirection === "desc") {
            filteredVideos.reverse()
        }

        let watchOnYoutubeButton = document.getElementById('watchOnYoutubeButton');
        if (filteredVideos.length > 0) {
            watchOnYoutubeButton.classList.remove('disabled')
        } else if (!watchOnYoutubeButton.classList.contains('disabled')) {
            watchOnYoutubeButton.classList.add('disabled')
        }

        changePage(1, true)
    }

    function draw() {
        drawFilters()
        drawFilterResultsContainer()
        drawTable();
        drawTablePagination()
    }

    function removePlayerFilter(type, name) {
        filters[type].splice(filters[type].indexOf(name), 1)
        applyFilters()
        draw()
    }

    function removeOpeningFilter(openingName) {
        filters.opening.splice(filters.opening.indexOf(openingName), 1)
        applyFilters()
        draw()
    }

    function drawFilters() {
        const filtersContainerElement = document.getElementById("filtersContainer");

        const nodes = []
        filters.anySide.forEach(playerName => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-secondary ml-1 mr-1'
            filterSpanElement.textContent = `Any side: ${playerName}`
            filterSpanElement.onclick = () => removePlayerFilter("anySide", playerName)
            nodes.push(filterSpanElement)
        })

        filters.white.forEach(playerName => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-light ml-1 mr-1'
            filterSpanElement.textContent = playerName
            filterSpanElement.onclick = () => removePlayerFilter("white", playerName)
            nodes.push(filterSpanElement)
        })

        filters.black.forEach(playerName => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-dark ml-1 mr-1'
            filterSpanElement.textContent = playerName
            filterSpanElement.onclick = () => removePlayerFilter("black", playerName)
            nodes.push(filterSpanElement)
        })

        filters.opening.forEach(openingName => {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = openingName
            filterSpanElement.onclick = () => removeOpeningFilter(openingName)
            nodes.push(filterSpanElement)
        })

        if (filters.pgnFilter !== "") {
            let filterSpanElement = document.createElement("span");
            filterSpanElement.className = 'badge badge-info ml-1 mr-1'
            filterSpanElement.textContent = "PGN: " + filters.pgnFilter
            filterSpanElement.onclick = () => {
                filters.pgnFilter = ""
                board.position("start")
                game.reset()
                applyFilters()
            }
            nodes.push(filterSpanElement)
        }

        $('#sortBySelect').val(sortBy)
        $('#sortDirectionSelect').val(sortDirection)

        filtersContainerElement.replaceChildren(...nodes)
    }

    function drawFilterResultsContainer() {
        const total = filteredVideos.length
        const withPlayers = filteredVideos.filter(video => video.getWhite()).length
        document.getElementById("filterResultsContainer").textContent = `Videos: ${total}, with players: ${withPlayers}`;
        if (Object.keys(videosPgns).length > 0) {
            const withPgns = filteredVideos.filter(video => videosPgns[video.id]).length
            document.getElementById("filterResultsContainer").textContent += `, with moves: ${withPgns}`;
        }
    }

    function drawTable() {
        let tableBodyElement = document.getElementById("tableBody");
        let newNodes = filteredVideos.slice((currentPageNumber - 1) * pageSize, (currentPageNumber) * pageSize)
            .map(video => {
                let tableRow = document.createElement("tr");

                let publishedAtCell = document.createElement("th");
                publishedAtCell.textContent = video.date
                publishedAtCell.className = 'd-none d-lg-block'
                tableRow.appendChild(publishedAtCell)

                let titleCell = document.createElement("td");
                let titleHref = document.createElement("a");
                titleHref.href = "https://www.youtube.com/watch?v=" + video.id
                titleHref.target = "_blank"
                titleHref.textContent = _.truncate(video.title, {
                    'length': 45,
                    'omission': '...'
                })
                titleCell.appendChild(titleHref)
                tableRow.appendChild(titleCell)

                let whitePlayerCell = document.createElement("td");
                if (video.getWhite()) {
                    whitePlayerCell.textContent = _.truncate(video.getWhite(), {
                        'length': 40,
                        'omission': '...'
                    })
                }
                tableRow.appendChild(whitePlayerCell)

                let blackPlayerCell = document.createElement("td");
                if (video.getBlack()) {
                    blackPlayerCell.textContent = _.truncate(video.getBlack(), {
                        'length': 40,
                        'omission': '...'
                    })
                }
                tableRow.appendChild(blackPlayerCell)
                return tableRow
            });

        tableBodyElement.replaceChildren(...newNodes)
    }

    function drawTablePagination() {
        let tablePaginationElement = document.getElementById("tablePagination");
        let paginationItems = tablePaginationElement.children
        Array.from(paginationItems).forEach(paginationItem => {
            if (paginationItem.className.indexOf("page-number-selector") > 0) {
                paginationItem.remove()
            }
        })
        // <li class="page-item page-number-selector"><a class="page-link" href="#">1</a></li>
        let pageNumbers = _.range(Math.max(1, currentPageNumber - 10), Math.min(filteredVideos.length / pageSize + 1, currentPageNumber + 10));
        let idxCurrent = pageNumbers.indexOf(currentPageNumber);
        pageNumbers
            .slice(Math.max(idxCurrent - 6, 0), Math.max(idxCurrent - 2, 0) + 9)
            .slice(0, 9)
            .forEach(nr => drawSinglePaginationPage(nr, nr === currentPageNumber))
    }

    function drawSinglePaginationPage(number, active) {
        let tablePaginationElement = document.getElementById("tablePagination");
        let liElement = document.createElement("li");
        liElement.className = "page-item page-number-selector " + (active ? "active" : "")
        let href = document.createElement("a");
        href.textContent = number
        href.className = "page-link text-center"
        href.href = "#"
        href.onclick = ev => changePage(number)
        liElement.appendChild(href)
        tablePaginationElement.insertBefore(liElement, tablePaginationElement.childNodes.item(tablePaginationElement.childNodes.length - 4))
    }

    $('.basicPlayerAutoComplete').autoComplete({
        resolver: 'custom',
        minLength: 2,
        events: {
            search: function (qry, callback) {
                let searchResult = players
                    .filter(player => player.name.toLowerCase().indexOf(qry.toLowerCase()) >= 0)
                    .map(player => player.name);
                callback(searchResult)
            }
        }
    })

    $('.openingAutoComplete').autoComplete({
        resolver: 'custom',
        minLength: 2,
        events: {
            search: function (qry, callback) {
                let searchResult = openings
                    .filter(opening => opening.name.toLowerCase().indexOf(qry.toLowerCase()) >= 0)
                    .map(opening => opening.name)
                callback(searchResult)
            }
        }
    })

    let game = null
    let board = null

    import {Chess} from 'https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.3/+esm'

    $('#collapsibleBoardFilterButton').on('click', function () {
        if (board == null) {
            loadBoard()
        }
    })

    function loadBoard() {
        game = new Chess()

        function onDragStart(source, piece) {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop
            let scrollLeft = window.pageXOffset || document.documentElement.scrollLeft

            window.onscroll = function () {
                window.scrollTo(scrollLeft, scrollTop);
            };

            setTimeout(function () {
                window.onscroll = function () {
                }
            }, 3000)

            if (game.isGameOver()) return false

            // only pick up pieces for the side to move
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false
            }
        }

        function onDrop(source, target) {
            window.onscroll = function () {
            }

            try {
                game.move({
                    from: source,
                    to: target,
                    promotion: 'q'
                })

                filters.pgnFilter = game.pgn()
                setTimeout(function () {
                    // hack for wrong display of white O-O
                    board.position(game.fen())
                }, 1)
                applyFilters()
            } catch (e) {
                return 'snapback'
            }
        }

        const config = {
            draggable: true,
            position: 'start',
            dropOffBoard: 'snapback',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapbackEnd: () => window.onscroll = function () {
            },
            onMoveEnd: () => window.onscroll = function () {
            }
        }

        $('#boardFilter').width(Math.min($("#collapsibleBoardFilter").width(), 400))
        board = Chessboard('boardFilter', config)
    }
</script>
</body>
</html>
